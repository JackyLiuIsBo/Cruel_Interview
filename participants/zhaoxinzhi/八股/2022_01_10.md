## 一、写在前面

今天顺着昨天的内容，继续看了**数据库**，特别是MySQL相关知识点，尽管有的知识感觉还消化不掉，先留坑以后再填。。



## 二、数据库

### 1、什么是自动提交？

MySQL默认采用自动提交`AUTOCOMMIT`模式。也就是说，如果不是显式地开始一个事务，则每个查询都被当作一个事务执行提交操作。

对于MyISAM或者内存表这些事务型的表（==这里错了吧应该是非事务型？==），修改`AUTOCOMMIT`不会有任何影响。对这类表来说，没有`COMMIT`或者`ROLLBACK`的概念，也可以说是相当于一直处于`AUTOCOMMIT`启用的模式。

如果在事务中混合使用了事务型和非事务型的表（例如InnoDB和MyISAM表）,在正常提交的情况下不会有什么问题。

但如果该事务需要回滚，非事务型的表上的变更就无法撤销，这会导致数据库处于不一致的状态，这种情况很难修复，事务的最终结果将无法确定。所以，为每张表选择合适的存储引擎非常重要。

### 2、MySQL中哪些存储引擎支持事务？

MySQL中InnoDB和NDB Cluster存储引擎提供了事务处理能力，以及其他支持事务的第三引擎。

### 3、MySQL存储引擎类型有哪些？

最常用的存储引擎是InnoDB引擎和MyISAM存储引擎。InnoDB是MySQL的默认事务引擎。

### 4、InnoDB存储引擎的特点和应用场景？

InnoDB是MySQL的默认「事务引擎」，被设置用来处理大量短期（short-lived）事务，短期事务大部分情况是正常提交的，很少会回滚。

### 5、InnoDB的特点

> 支持事务，支持外键，行锁
>
> 非阻塞读：通过MVCC实现读的非阻塞
>
> 阻塞写：在表锁的基础上，通过索引来实现行锁

1.支持事务，支持4个事务隔离级别，支持多版本读。

2.行级锁定（更新时一般是锁定当前行），通过索引实现，全表扫描仍然会是表锁，注意间隙锁的影响。

3.读写阻塞与事务隔离级别相关。

4.具有非常高效的缓存特性：能缓存索引，也能缓存数据。

5.整个表和主键以Cluster方式存储，组成一个平衡树。

6.所有Secondary Index都会保存主键信息。

7.支持分区，表空间，类似oracle数据库。

8.支持外键约束，5.5之前不支持全文索引，5.5之后支持外键索引。

9.和Myisam引擎比，Innodb对硬件资源要求比较高。



采用多版本并发控制（MVCC，Multi Version Concurrency Control）来支持高并发。并且实现了四个标准的隔离级别，通过间隙锁`next-key locking`策略防止幻读的出现。

引擎的表基于聚簇索引建立，聚簇索引对主键查询有很高的性能。不过它的二级索引`secondary index`非主键索引中必须包含主键列，所以如果主键列很大的话，其他的所有索引都会很大。因此，若表上的索引较多的话，主键应当尽可能的小。另外InnoDB的存储格式是平台独立。

InnoDB做了很多优化，比如：磁盘读取数据方式采用的可预测性预读、自动在内存中创建hash索引以加速读操作的自适应哈希索引（adaptive hash index)，以及能够加速插入操作的插入缓冲区（insert buffer)等。

InnoDB通过一些机制和工具支持真正的热备份，MySQL的其他存储引擎不支持热备份，要获取一致性视图需要停止对所有表的写入，而在读写混合场景中，停止写入可能也意味着停止读取。

### 6、Innodb引擎适用的生产场景

1、需要事务支持的业务（具有较好的事务特性）

2、行级锁定对高并发有很好的适应能力，但需要确保查询时通过索引完成。（==事务1通过索引，事务2不通过索引，那事务1会上行锁吗？事务2如何处理？能加上表锁吗？==）

3、数据读写及更新都较为频繁的场景，如：bbs，sns，微博，微信等。

4、数据一致性要求较高的业务，例如：充值转账，银行卡转账。

5、硬件设备内存较大，可以利用Innodb较好的缓存能力来提高内存利用率，尽可能减少磁盘IO。

### 7、Innodb 引擎调优

**1、主键尽可能小，避免给 二级索引 带来过大的空间负担。**

**2、建立有效索引避免全表扫描，因为会使用表锁。**

**3、尽可能缓存所有的索引和数据，提高响应速度，减少产品IO消耗。**

4、在大批量小插入的时候，尽量自己控制事务而不要使用autocommit自动提交。有开关可以控制提交方式

5、合理设置innodb_flush_log_at_trx_commit参数值，不要过度追求安全性。

如果innodb_flush_log_at_trx_commit的值为0，log buffer每秒就会被刷写日志文件到磁盘，提交事务的时候不做任何操作。

**6、避免主键更新，因为这会带来大量的数据移动。**



### 8、myisam 引擎的特点

> 支持事务，支持外键，行锁，支持全文索引
>
> 读写相互阻塞

1.不支持事务

2.表级锁定，数据更新时锁定整个表：其锁定机制是表级锁定，这虽然可以让锁定的实现成本很小但是也同时大大降低了其并发性能。

3.读写互相阻塞：不仅会在写入的时候阻塞读取，myisam还会在读取的时候阻塞写入，但读本身并不会阻塞另外的读。

4.只会缓存索引：myisam可以通过key_buffer_size缓存索引，以大大提高访问性能，减少产品IO，但是这个缓存区只会缓存索引，而不会缓存数据。

5.读取速度较快，占用资源相对少。

6.不支持外键约束，但支持全文索引。

 

### 9、MyiSAM 引攀适用的生产业务场景

> 单一对数据库的操作都可以使用MyiSAM，所谓单一就是尽量纯读，或纯写 ( insert . update , delete ）等

1 、不需要事务支持的业务（例如转账就不行）。

2 、一般为读数据比较多的应用，读写都频繁场景不适合，读多或者写多的都适合。

3 、读写并发访问相对较低的业务（纯读纯写高并发也可以）（锁定机制问题）

4 、数据修改相对较少的业务（阻塞问题）。

5 、以读为主的业务，例如：数据库系统表、www， blog ，图片信息数据库，用户数据库，商品库等业务。

6 、对数据一致性要求不是非常高的业务（不支持事务）。

7 、硬件资源比较差的机器可以用 MyiSAM （占用资源少）

8 、使用读写分离的 MySQL 从库可以使用 MyISAM。

### 6、InnoDB与MyISAM对比

待填坑。。

### 7、MySQL共享锁、排他锁、悲观锁、乐观锁

待填坑。。
