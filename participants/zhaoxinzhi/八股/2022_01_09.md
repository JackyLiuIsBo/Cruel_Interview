## 一、写在前面

今天了解了下关于**数据库**的的知识，主要是一致性通常是如何保证的，如何做的优化，以及如何保证一致性。



## 二、数据库

### 1、关于数据库与缓存的一致性

为了保证一致性，更新数据时应该先淘汰缓存还是先修改数据库？

当数据发生变化时，“先淘汰缓存，再修改数据库”。

注意是淘汰缓存，而不是把新数据放入缓存中。

### 2、事务的ACID特性

原子性（atomicity)   一个事务必须被视为一个不可分割的最小工作单元，整个事务中的所有操作要么全部提交成功，要么全部失败回滚，对于一个事务来说，不可能只执行其中的一部分操作。

一致性（consistency)   数据库总是从一个一致性的状态转换到另外一个一致性的状态。只要事务最终没有提交，事务中所做的修改也不会保存到数据库中。

隔离性（isolation)   通常来说，一个事务所做的修改在最终提交以前，对其他事务是不可见的。比如A有100元，打算给B转账10元，事务中应该包含：A账户-10，B账户+10。在A账户-10之后，此时如果有人查看A账户的余额，看到的还是100元，而不是90元。

持久性（durability)   一旦事务提交，则其所做的修改就会永久保存到数据库中。此时即使系统崩溃，修改的数据也不会丢失。持久性是个有点模糊的概念，因为实际上持久性也分很多不同的级别。有些持久性策略能够提供非常强的安全保障，而有些则未必。而且「不可能有能做到100%的持久性保证的策略」否则还需要备份做什么。

#### ACID靠什么保证？

原子性靠undo log保证，事务回滚时撤销已经成功执行的sql。

一致性靠应用层保证。

隔离性靠MVCC保证。

持久性靠redo log保证。

### 3、什么是脏读、不可重复读、幻读？

>  参考链接https://www.zhihu.com/question/31346392/answer/1707203839

脏读：在事务A修改数据之后提交数据之前，这时另一个事务B来读取数据，如果不加控制，事务B读取到A修改过数据，之后A又对数据做了修改再提交，则B读到的数据是脏数据，此过程称为脏读Dirty Read。

不可重复读：一个事务内在读取某些数据后的某个时间，再次读取以前读过的数据，却发现其读出的数据已经发生了变更、或者某些记录已经被删除了。

幻读：事务A在按查询条件读取某个范围的记录时，事务B又在该范围内插入了新的满足条件的记录，当事务A再次按条件查询记录时，会产生新的满足条件的记录（幻行 Phantom Row）

#### 不可重复读与幻读有什么区别？

- 不可重复读的重点是修改：在同一事务中，同样的条件，第一次读的数据和第二次读的「数据不一样」。（因为中间有其他事务提交了修改）
- 幻读的重点在于新增或者删除：在同一事务中，同样的条件，第一次和第二次读出来的「记录数不一样」。（因为中间有其他事务提交了插入/删除）

> 脏读和事务的隔离性，冲突吗？
>
> 参考链接https://bbs.csdn.net/topics/391080845
>
> Q1：因为事务A读取了事务B中修改了但未提交的数据，称为脏读。那么事务A本身就违背了自身的隔离性原则。它还算是个事务吗？
>
> A1：不冲突，事务的隔离性并不是：A事务修改的东西，B看不到，事务的隔离是有级别的，隔离的具体行为取决于隔离级别设置，默认的隔离级别满足不允许脏读，事务隔离级别为未提交（uncommited）读才会出现这样情况（允许脏读的数据库存储引擎只有sqlserver？）。mysql的myisam引擎是表级别的所，innodb引擎读到的也是已提交的数据。能读取脏数据的只有 sql server了，你可以在查询中指定 nolock，或者 指定隔离级别为 read uncommitted，这个就是脏读，也就是说可以读取到未提交的数据，那么好处是在读取数据时不需要读锁，所以不会被修改数据的事务锁定。
>
> Q2：那么有哪些适用允许脏读这种低隔离级别（未提交读）的场景呢？
>
> A2：这种允许脏读只要不影响业务的正常处理，是没关系的。比如有一个论坛，一个人在发贴子，发了帖子之后要更新此人的发贴数啊，最后活动时间啊，金币啊等等乱七八糟的东西，可能还有更新全局的论坛发贴数量，我们可以把这些看成是一个事务。另外有一个需要读取当天所有人发贴数的地方，这个并不需要在这个事务跑完再读取，脏读读到的结果完全可以满足我们的需要，我们就可以在这个场景下使用脏读。而如果完全事务隔离，因为可能同时有很多人在发贴，就会影响读取的效率。

### 4、SQL四种隔离级别

SQL实现了四个标准的隔离级别，每一种级别都规定了一个事务中所做的修改，哪些在事务内和事务间是可见的，哪些是不可见的。低级别的隔离级一般支持更高的并发处理，并拥有更低的系统开销。

[![7ZmPsS.png](https://s4.ax1x.com/2022/01/11/7ZmPsS.png)](https://imgtu.com/i/7ZmPsS)

[![7ZEdER.png](https://s4.ax1x.com/2022/01/10/7ZEdER.png)](https://imgtu.com/i/7ZEdER)





















